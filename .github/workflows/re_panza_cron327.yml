import os
import json
import requests
import time
from client import RePanzaClient

def run_scanner():
    EMAIL = os.getenv("LK_EMAIL")
    PASSWORD = os.getenv("LK_PASSWORD")
    
    client = RePanzaClient.auto_login(EMAIL, PASSWORD)
    if not client:
        return

    # Endpoint Classifica Mondo 327
    url_ranking = "https://backend3.lordsandknights.com/XYRALITY/WebObjects/LKWorldServer-RE-IT-6.woa/wa/PlayerAction/getRanking"
    all_players = []
    offset = 0
    step = 100
    
    print(f"üöÄ SID Preso ({client.session_id[:8]})! Simulazione caricamento mappa...")
    # Aspettiamo 20 secondi per simulare il tempo che un umano impiega a vedere i castelli
    time.sleep(20) 

    # Header per simulare un browser reale ed evitare il blocco API
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept": "application/json, text/javascript, */*; q=0.01",
        "X-Requested-With": "XMLHttpRequest",
        "Referer": "https://www.lordsandknights.com/"
    }

    while True:
        try:
            params = {
                "sessionID": client.session_id,
                "offset": offset,
                "count": step,
                "rankingType": 0
            }
            
            response = requests.get(url_ranking, params=params, headers=headers, timeout=30)
            
            # Se riceviamo HTML (errore), stampiamo il motivo reale invece di crashare
            if "application/json" not in response.headers.get("Content-Type", "").lower():
                print(f"‚ö†Ô∏è Il server rifiuta il JSON. Risposta del server: {response.text[:150]}")
                break

            data = response.json()
            players = data.get('allRankings', [])
            
            if not players:
                break
            
            all_players.extend(players)
            print(f"üì• Scaricati {len(all_players)} player...")
            
            if len(players) < step:
                break
                
            offset += step
            time.sleep(1) # Pausa pi√π lunga per non insospettire il server
            
        except Exception as e:
            print(f"üí• Errore parsing: {e}")
            break

    if all_players:
        with open("database_classificamondo327.json", "w", encoding="utf-8") as f:
            json.dump(all_players, f, indent=4, ensure_ascii=False)
        RePanzaClient.send_telegram_alert(f"‚úÖ Scansione completata: {len(all_players)} player.")
    else:
        print("‚ùå Scansione fallita: il server ha restituito solo pagine di errore.")
