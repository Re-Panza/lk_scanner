import os
import json
import requests
import time
from client import RePanzaClient

def run_scanner():
    # Recupero credenziali dai Secrets di GitHub
    EMAIL = os.getenv("LK_EMAIL")
    PASSWORD = os.getenv("LK_PASSWORD")
    
    # 1. Fase di Login e intercettazione SID
    print("üöÄ Avvio RePanza Oracle...")
    client = RePanzaClient.auto_login(EMAIL, PASSWORD)
    
    if not client or not client.session_id:
        print("‚ùå Login fallito: SessionID non ottenuto. Esco.")
        return

    # 2. Configurazione Scansione Diretta via API
    # Usiamo l'endpoint che fornisce i dati grezzi della classifica
    url_ranking = "https://backend3.lordsandknights.com/XYRALITY/WebObjects/LKWorldServer-RE-IT-6.woa/wa/PlayerAction/getRanking"
    
    all_players = []
    offset = 0
    step = 100 
    
    print(f"üì° SID Ottenuto: {client.session_id[:10]}...")
    print(f"üì• Inizio download classifica Mondo 327...")
    RePanzaClient.send_telegram_alert(f"üîÆ Oracle: Login OK. Inizio scansione classifica...")

    while True:
        try:
            # Parametri della richiesta API
            params = {
                "sessionID": client.session_id,
                "offset": offset,
                "count": step,
                "rankingType": 0 # Classifica Punti
            }
            
            # Chiamata HTTP diretta al server
            response = requests.get(url_ranking, params=params, timeout=20)
            
            if response.status_code != 200:
                print(f"‚ö†Ô∏è Errore API (Status {response.status_code}). Provo a continuare...")
                break
            
            data = response.json()
            players = data.get('allRankings', [])
            
            if not players:
                print("üèÅ Fine della classifica raggiunta.")
                break
            
            all_players.extend(players)
            print(f"‚úÖ Scaricati {len(all_players)} giocatori (Offset: {offset})...")
            
            # Se il server manda meno di 100 player, siamo alla fine
            if len(players) < step:
                break
                
            offset += step
            time.sleep(0.3) # Pausa per non essere rilevati come spammer
            
        except Exception as e:
            print(f"üí• Errore durante il download: {e}")
            break

    # 3. Salvataggio Database JSON
    if all_players:
        filename = "database_classificamondo327.json"
        with open(filename, "w", encoding="utf-8") as f:
            json.dump(all_players, f, indent=4, ensure_ascii=False)
        
        success_msg = f"üìä Scansione completata!\nüì¶ Player salvati: {len(all_players)}"
        print(f"üíæ {success_msg}")
        RePanzaClient.send_telegram_alert(success_msg)
    else:
        print("‚ö†Ô∏è Nessun dato salvato: la classifica √® vuota o l'API ha rifiutato la richiesta.")

if __name__ == "__main__":
    run_scanner()
